name: Build and Publish Wheels

on:
  workflow_dispatch:
  push:
    tags: ["v*"]
  schedule:
    # Run weekly to keep wheels updated
    - cron: '0 0 * * 0'

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  define_matrix_cuda:
    name: Define CUDA Build Matrix
    runs-on: ubuntu-22.04
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    defaults:
      run:
        shell: pwsh

    steps:
      - name: Define Job Output
        id: set-matrix
        run: |
          $matrix = @{
              'os' = @('ubuntu-22.04')
              'pyver' = @("3.9", "3.10", "3.11", "3.12")
              'cuda' = @("12.1.1", "12.2.2", "12.3.2", "12.4.1")
              'releasetag' = @("basic")
          }

          $matrixOut = ConvertTo-Json $matrix -Compress
          Write-Output ('matrix=' + $matrixOut) >> $env:GITHUB_OUTPUT

  build_wheels_cuda:
    name: Build CUDA ${{ matrix.pyver }} cu${{ matrix.cuda }}
    needs: define_matrix_cuda
    runs-on: ${{ matrix.os }}
    strategy:
      matrix: ${{ fromJSON(needs.define_matrix_cuda.outputs.matrix) }}
    defaults:
      run:
        shell: pwsh
    env:
      CUDAVER: ${{ matrix.cuda }}
      AVXVER: ${{ matrix.releasetag }}

    steps:
      - uses: actions/checkout@v6
        with:
          submodules: "recursive"

      - uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.pyver }}
          cache: 'pip'

      - name: Setup Mamba
        uses: conda-incubator/setup-miniconda@v3.1.0
        with:
          activate-environment: "llamacpp"
          python-version: ${{ matrix.pyver }}
          miniforge-version: latest
          add-pip-as-python-dependency: true
          auto-activate-base: false

      - name: Install Dependencies
        env:
          MAMBA_DOWNLOAD_FAILFAST: "0"
          MAMBA_NO_LOW_SPEED_LIMIT: "1"
        run: |
          $cudaVersion = $env:CUDAVER
          mamba install -y 'cuda' -c nvidia/label/cuda-$cudaVersion
          python -m pip install build wheel

      - name: Build Wheel
        run: |
          $cudaVersion = $env:CUDAVER.Remove($env:CUDAVER.LastIndexOf('.')).Replace('.','')
          $env:CUDA_PATH = $env:CONDA_PREFIX
          $env:CUDA_HOME = $env:CONDA_PREFIX
          $env:CUDA_TOOLKIT_ROOT_DIR = $env:CONDA_PREFIX
          if ($IsLinux) {
            $env:LD_LIBRARY_PATH = $env:CONDA_PREFIX + '/lib:' + $env:LD_LIBRARY_PATH
          }
          $env:VERBOSE = '1'
          $env:CMAKE_ARGS = '-DGGML_CUDA=on -DCMAKE_CUDA_ARCHITECTURES=all'
          $env:CMAKE_ARGS = "-DGGML_CUDA_FORCE_MMQ=ON $env:CMAKE_ARGS"
          $env:CMAKE_ARGS = $env:CMAKE_ARGS + ' -DGGML_AVX2=off -DGGML_FMA=off -DGGML_F16C=off'
          python -m build --wheel
          # Save CUDA version
          Write-Output "CUDA_VERSION=$cudaVersion" >> $env:GITHUB_ENV

      - uses: actions/upload-artifact@v6
        with:
          name: wheel-cuda-${{ matrix.pyver }}-cu${{ env.CUDA_VERSION }}
          path: dist/*.whl
          retention-days: 7

  build_wheels_cpu:
    name: Build CPU ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-22.04, windows-2022]

    steps:
      - uses: actions/checkout@v6
        with:
          submodules: "recursive"

      - uses: actions/setup-python@v6
        with:
          python-version: "3.9"

      - name: Install dependencies (Linux)
        if: runner.os != 'Windows'
        run: |
          python -m pip install --upgrade pip
          python -m pip install uv
          RUST_LOG=trace python -m uv pip install -e .[all] --verbose
        shell: bash

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        env:
          RUST_LOG: trace        
        run: |
          python -m pip install --upgrade pip
          python -m pip install uv
          python -m uv pip install -e .[all] --verbose
        shell: cmd

      - name: Build wheels
        uses: pypa/cibuildwheel@v3.3.1
        env:
          CIBW_REPAIR_WHEEL_COMMAND: ""
        with:
          package-dir: .
          output-dir: wheelhouse

      - uses: actions/upload-artifact@v6
        with:
          name: wheel-cpu-${{ matrix.os }}
          path: ./wheelhouse/*.whl
          retention-days: 7

  generate_pypi_index:
    name: Generate PyPI Index
    needs: [build_wheels_cuda, build_wheels_cpu]
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: wheels-all
          merge-multiple: false

      - name: Organize wheels by CUDA version
        shell: pwsh
        run: |
          # Create directory structure
          New-Item -ItemType Directory -Force -Path "dist/whl/cpu"
          New-Item -ItemType Directory -Force -Path "dist/whl/cu121"
          New-Item -ItemType Directory -Force -Path "dist/whl/cu122"
          New-Item -ItemType Directory -Force -Path "dist/whl/cu123"
          New-Item -ItemType Directory -Force -Path "dist/whl/cu124"

          # Organize wheels by version
          Get-ChildItem -Path "wheels-all" -Recurse -Filter "*.whl" | ForEach-Object {
              $wheelName = $_.Name
              if ($wheelName -match "wheel-cpu") {
                  Copy-Item $_.FullName -Destination "dist/whl/cpu/"
                  Write-Host "CPU: $wheelName"
              }
              elseif ($wheelName -match "cu121") {
                  Copy-Item $_.FullName -Destination "dist/whl/cu121/"
                  Write-Host "CUDA 12.1: $wheelName"
              }
              elseif ($wheelName -match "cu122") {
                  Copy-Item $_.FullName -Destination "dist/whl/cu122/"
                  Write-Host "CUDA 12.2: $wheelName"
              }
              elseif ($wheelName -match "cu123") {
                  Copy-Item $_.FullName -Destination "dist/whl/cu123/"
                  Write-Host "CUDA 12.3: $wheelName"
              }
              elseif ($wheelName -match "cu124") {
                  Copy-Item $_.FullName -Destination "dist/whl/cu124/"
                  Write-Host "CUDA 12.4: $wheelName"
              }
          }

          # List contents
          Get-ChildItem -Path "dist/whl" -Recurse

      - name: Generate PyPI indices
        run: |
          python << 'PYEOF'
          import os
          from pathlib import Path
          import hashlib
          
          def generate_index(wheel_dir, package_name="llama-cpp-python"):
              """Generate PEP 503 compatible HTML index"""
              wheels = sorted(Path(wheel_dir).glob("*.whl"))
              
              if not wheels:
                  return None
              
              html = [
                  '<!DOCTYPE html>',
                  '<html>',
                  '  <head>',
                  '    <meta charset="utf-8">',
                  '    <meta name="pypi:repository-version" content="1.0">',
                  f'    <title>Links for {package_name}</title>',
                  '  </head>',
                  '  <body>',
                  f'    <h1>Links for {package_name}</h1>'
              ]
              
              for wheel in wheels:
                  wheel_name = wheel.name
                  sha256 = hashlib.sha256(wheel.read_bytes()).hexdigest()
                  html.append(f'    <a href="{wheel_name}#sha256={sha256}">{wheel_name}</a><br/>')
              
              html.extend(['  </body>', '</html>'])
              return '\n'.join(html)
          
          # Generate index for each configuration
          configs = {
              'cpu': 'CPU',
              'cu121': 'CUDA 12.1',
              'cu122': 'CUDA 12.2', 
              'cu123': 'CUDA 12.3',
              'cu124': 'CUDA 12.4'
          }
          
          available_configs = []
          
          for config, label in configs.items():
              wheel_dir = f'dist/whl/{config}'
              if os.path.exists(wheel_dir):
                  index_html = generate_index(wheel_dir)
                  if index_html:
                      with open(f'{wheel_dir}/index.html', 'w', encoding='utf-8') as f:
                          f.write(index_html)
                      print(f"âœ“ Generated index for {label}")
                      available_configs.append((config, label))
                  else:
                      print(f"âœ— No wheels found for {label}")
          
          # Generate root index
          root_html = [
              '<!DOCTYPE html>',
              '<html>',
              '  <head>',
              '    <meta charset="utf-8">',
              '    <title>llama-cpp-python - PyPI Index</title>',
              '    <style>',
              '      body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 900px; margin: 40px auto; padding: 0 20px; }',
              '      h1 { color: #2c3e50; }',
              '      .config { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 5px; }',
              '      .config h2 { margin-top: 0; color: #34495e; }',
              '      code { background: #e9ecef; padding: 2px 6px; border-radius: 3px; font-size: 0.9em; }',
              '      a { color: #3498db; text-decoration: none; }',
              '      a:hover { text-decoration: underline; }',
              '    </style>',
              '  </head>',
              '  <body>',
              '    <h1>ðŸ¦™ llama-cpp-python Wheels</h1>',
              '    <p>Pre-compiled wheels for <code>llama-cpp-python</code> with different CUDA versions.</p>'
          ]
          
          for config, label in available_configs:
              root_html.extend([
                  '    <div class="config">',
                  f'      <h2><a href="whl/{config}/">{label}</a></h2>',
                  f'      <code>pip install llama-cpp-python --extra-index-url https://USERNAME.github.io/REPO/whl/{config}</code>',
                  '    </div>'
              ])
          
          root_html.extend([
              '    <hr>',
              '    <p><small>Generated automatically by GitHub Actions</small></p>',
              '  </body>',
              '</html>'
          ])
          
          with open('dist/index.html', 'w', encoding='utf-8') as f:
              f.write('\n'.join(root_html))
          
          print("âœ“ Generated root index")
          PYEOF

      - name: Create README
        run: |
          cat > dist/README.md << 'EOF'
          # ðŸ¦™ llama-cpp-python Wheels
          
          Pre-compiled wheels for `llama-cpp-python` with CPU and CUDA support.
          
          ## ðŸ“¦ Installation
          
          ### CPU Only (no GPU acceleration)
          ```bash
          pip install llama-cpp-python --extra-index-url https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/whl/cpu
          ```
          
          ### CUDA 12.1
          ```bash
          pip install llama-cpp-python --extra-index-url https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/whl/cu121
          ```
          
          ### CUDA 12.2
          ```bash
          pip install llama-cpp-python --extra-index-url https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/whl/cu122
          ```
          
          ### CUDA 12.3
          ```bash
          pip install llama-cpp-python --extra-index-url https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/whl/cu123
          ```
          
          ### CUDA 12.4
          ```bash
          pip install llama-cpp-python --extra-index-url https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/whl/cu124
          ```
          
          ## âœ… Verification
          
          After installation:
          ```python
          from llama_cpp import Llama
          print("llama-cpp-python installed successfully!")
          ```
          
          ## ðŸ“‹ Available Wheels
          
          - **CPU**: Multiple Python versions (Linux, Windows)
          - **CUDA**: Python 3.9, 3.10, 3.11, 3.12 (Linux only)
          
          ## ðŸ”„ Update Schedule
          
          Wheels are rebuilt:
          - On every new tag (manual releases)
          - Weekly (automated)
          - On manual workflow dispatch
          
          ---
          
          **Repository**: [${{ github.repository }}](https://github.com/${{ github.repository }})
          
          **Upstream**: [abetlen/llama-cpp-python](https://github.com/abetlen/llama-cpp-python)
          EOF

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
